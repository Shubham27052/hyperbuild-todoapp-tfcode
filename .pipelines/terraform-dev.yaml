trigger:
  paths:
    include:
      - environments/dev/*


variables:
 - group: terraform-secrets

stages:
  - stage: TerraformDeployment
    displayName: Terraform CI/CD
    jobs:
      - job: DeployDevEnv
        displayName: "Deploy Dev environment"
        pool:
            name: noteapp-agents
        steps:
            - script: |
                cd $(Build.SourcesDirectory)/environments/dev/
                terraform init -input=false
              env:
                ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
                ARM_TENANT_ID : $(ARM_TENANT_ID)
                ARM_USE_MSI: $(ARM_USE_MSI)
              displayName: 'Terraform Init'

            - script: |
                cd $(Build.SourcesDirectory)/environments/dev/                
                terraform plan -out=tfplan
              displayName: 'Terraform Plan'

            - script: |
                cd $(Build.SourcesDirectory)/environments/dev/                
                terraform apply -auto-approve tfplan
              displayName: 'Terraform Apply'
